---
title: "Extracting taxonomy information from sequence metadata"
author: "Zachary Foster"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
%\VignetteIndexEntry{Extracting taxonomy information from sequence headers}
%\VignetteEngine{knitr::rmarkdown}
%\usepackage[utf8]{inputenc}
---


```{r}
library(ape)
library(metacoder)
```




### Genbank FASTA headers

```{r}
sequences <- ape::read.FASTA("inst/extdata/ncbi_basidiomycetes.fasta")
tax_info <- extract_taxonomy(names(sequences),
                             regex = "^.*\\|(.*)\\|.*\\|(.*)\\|.*$",
                             key = c("item_id", other_id = "item_info"),
                             database = "ncbi")
```


### UNITE FASTA headers

The format of the UNITE fasta release has two peices of information from which taxonomy can be determined.
The genbank sequence identifier can be used to look up the taxon id from Genbank.
Alternativly, the classifications specified in the header can be used to make an arbitrarily coded taxonomy.

#### Using the sequece identifier

The genbank accession number in the second entry of UNITE sequence headers can be used to look up the taxon assigned to each sequence by genbank. 
This is better than using the taxonomy from the sequence header since the genbank unique taxon ids (uids) will be used to identify taxa instead of arbitrary ids. 
Also, looking up the taxon assignment using the sequence accession number means changes in sequence taxonomy since the UNITE databsae was downloaded will be included. 

```{r}
sequences <- ape::read.FASTA("inst/extdata/unite_general_release.fasta")
cat(names(sequences)[1])
tax_info <- extract_taxonomy(names(sequences)[1:5],
                             regex = "^(.*)\\|(.*)\\|(.*)\\|.*\\|(.*)$",
                             key = c("taxon_name", "item_id", other_id = "item_info", "lineage"),
                             database = "ncbi")
```

#### Using the included classifications to look up taxon id

Note that the taxon name (entry 1) and the sequence id (entry 2) are now encoded as `"item_info"`, causing them to be interpreted as generic data. 
This means that 

```{r}
sequences <- ape::read.FASTA("inst/extdata/unite_general_release.fasta")
tax_info <- extract_taxonomy(names(sequences)[1:5],
                             regex = "^(.*)\\|(.*)\\|(.*)\\|.*\\|(.*)$",
                             key = c(name = "item_info", seq_id = "item_info",
                                     other_id = "item_info", "class_name"),
                             database = "ncbi")
```

#### Using the included classifications to generate arbitrary ids

It is also possible to build a custom taxonomy encoding using the taxonomy string (e.g. `k__Fungi;p__Ascomycota;c__Leotiomycetes`) in the sequence headers without looking up the unique taxon ids of each taxon.
Taxa will be assigned arbitrary taxon ids that will be specific to the current analysis.
To do this, set the `use_internet` option to `FALSE`.

```{r}
sequences <- ape::read.FASTA("inst/extdata/unite_general_release.fasta")
tax_info <- extract_taxonomy(names(sequences)[1:5],
                             regex = "^(.*)\\|(.*)\\|(.*)\\|.*\\|(.*)$",
                             key = c(name = "item_info", seq_id = "item_info",
                                     other_id = "item_info", "class_name"),
                             database = "ncbi", 
                             allow_arbitrary_ids = TRUE)
```


### ITS1 DB FASTA headers

```{r}
sequences <- ape::read.FASTA("inst/extdata/ITSoneDB_ITS1_GBandHMM.fasta")
tax_info <- extract_taxonomy(names(sequences),
                             regex = "^(.*)_.*\\|(.*)\\|(.*)\\|(.*)$",
                             key = c("item_id", name = "taxon_info",
                                     "taxon_id", description = "taxon_info"),
                             database = "ncbi")
```


### PR2 FASTA headers

```{r}
sequences <- ape::read.FASTA("inst/extdata/pr2_stramenopiles_gb203.fasta")
tax_info <- extract_taxonomy(names(sequences),
                             regex = "^(.*\\..*)\\..*\\|(.*)$",
                             key = c("item_id", "lineage"),
                             database = "ncbi", 
                             lineage_tax_sep = "|")
```


### RDP FASTA headers

```{r}
sequences <- ape::read.FASTA("inst/extdata/rdp_release11_3_Archaea_unaligned.fa")
tax_info <- extract_taxonomy(names(sequences),
                             regex = "^(.*) (.*);(.*)\\tLineage=(.*)",
                             key = c(id = "item_info", description = "item_info",
                                     other_id = "item_info", "lineage"),
                             database = "ncbi", 
                             lineage_tax_sep = ";",
                             lineage_rank_sep = ";", 
                             lineage_rank_rev)
```