---
title: "Comparing 16S databases"
output:
  html_document:
    toc: false
    css: custom.css
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(ape)
library(metacoder)
library(knitr)
library(magrittr)
source("knitr_settings.R")
```


### SILVA

#### Parse file

```{r}
file_path <- "data/SILVA_123.1_SSURef_Nr99_tax_silva.fasta"
silva <- extract_taxonomy(seqinr::read.fasta(file_path, as.string = TRUE),
                          regex = "^(.*?) (.*)$",
                          key = c(id = "item_info", "class"),
                          class_sep = ";")
silva
```

#### Subset

```{r}
silva <- filter_taxa(silva, name == "Bacteria", subtaxa = TRUE) %>%
  sample_n_items(size = 100000, taxon_weight = 1 / item_counts, itemless = FALSE) %>%
  filter_taxa(item_counts > 10)
```

```{r}
filter_taxa(silva, taxon_ranks < 6, subtaxa = FALSE) %>%
  filter_taxa(item_counts > 10, subtaxa = FALSE) %>%
  plot(vertex_size = item_counts,
       vertex_color = item_counts,
       vertex_label = name)
```



#### PCR

```{r}
silva$item_data$sequence <- gsub(pattern = "u", replacement = "t", silva$item_data$sequence)
pcr <- filter_taxa(silva, taxon_ranks < 7, subtaxa = FALSE) %>%
  filter_taxa(item_counts > 10, subtaxa = FALSE) %>%
  primersearch(forward = "CTCCTACGGGAGGCAGCAG", reverse = "GWATTACCGCGGCKGCTG",
               pair_name = "357F_519R",  mismatch = 10)
```


```{r}
plot(pcr,
     vertex_size = item_counts,
     vertex_label = name,
     vertex_color = prop_amplified,
     vertex_color_range =  c("red", "cyan"),
     vertex_color_trans = "radius")
```

```{r}
filter_taxa(pcr, prop_amplified < 0.9, subtaxa = FALSE, supertaxa = TRUE) %>%
  plot(vertex_size = item_counts,
     vertex_label = name,
     vertex_color = prop_amplified,
     vertex_color_range =  c("red", "cyan"),
     vertex_color_trans = "radius")
```


