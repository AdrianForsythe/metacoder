---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(metacoder)
```

## Creating the in silico PCR dataset

### Parse SILVA FASTA file

```{r}
silva_path <- "SILVA_132_SSURef_Nr99_tax_silva.fasta"
raw_silva <- metacoder::read_fasta(silva_path)
first_subset <- sample(seq_along(raw_silva), 1000)
silva <- parse_silva_fasta(input = raw_silva[first_subset])
silva <- filter_ambiguous_taxa(silva, subtaxa = TRUE, reassign_obs = FALSE)
silva <- filter_taxa(silva, n_obs > 0)
```


```{r}
silva %>%
  heat_tree(node_color = n_obs, 
            node_size = n_obs,
            node_label = taxon_names,
            output_file = "temp.pdf")
```


### Subset to a reasonable size

```{r}
silva_subset <- filter_taxa(silva, taxon_names == "Bacteria", subtaxa = TRUE)
```


```{r}
silva_subset %>%
  heat_tree(node_color = n_obs, 
            node_size = n_obs,
            node_label = taxon_names,
            output_file = "temp.pdf", layout = "da", initial_layout = "re")
```

### Write FASTA subset

```{r}
out_path <- "silva_subset.fa"
writeChar(paste0(paste0(">", silva_subset$data$tax_data$input, "\n", silva_subset$data$silva_seq), collapse = "\n"),
          "silva_subset.fa")
file.copy(from = out_path, to = file.path("..", "inst", "extdata", out_path))
```


### Test in silico PCR

#### Dummy set

```{r}
rev_comp <- function(my_seq) {
  toupper(paste0(rev(seqinr::comp(strsplit(my_seq, "")[[1]], ambiguous = TRUE)), collapse = ""))
}


comp <- function(my_seq) {
  toupper(paste0(seqinr::comp(strsplit(my_seq, "")[[1]], ambiguous = TRUE), collapse = ""))
}


primer_1_site <- "AAGTACCTTAACGGAATTATAG"
primer_2_site <- "ATTCGTTTCGTAGGTGGAGC"
amplicon <- "NNNAGTGGATAGATAGGGGTTCTGTGGCGTTTGGGAATTAAAGATTAGAGANNN"
seq_1 <- paste0("AA", primer_1_site, amplicon, primer_2_site, "AAAA")
seq_2 <- rev_comp(seq_1)

f_primer <- primer_1_site
r_primer <- rev_comp(primer_2_site)
seqs <- c(a = seq_1, b = seq_2)

result <- primersearch(seqs, 
                       forward = c("p1" = f_primer),
                       reverse = c("p2" = r_primer))
```


#### Real data set

```{r}
silva_subset <- parse_silva_fasta(out_path)
pcr_result <- primersearch(silva_subset$data$silva_seq, 
                           forward = c("U519F" = "CAGYMGCCRCGGKAAHACC"),
                           reverse = c("Arch806R" = "GGACTACNSGGGTMTCTAAT"),
                           mismatch = 10)
```

